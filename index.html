<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generative Flow â€” aivars.se</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#050510}
canvas{display:block;width:100%;height:100%}
#controls{
  position:fixed;bottom:16px;right:16px;
  display:flex;gap:8px;align-items:center;
  font-family:'Courier New',monospace;font-size:12px;color:rgba(200,210,230,0.6);
  z-index:10;user-select:none;
  transition:opacity .3s;opacity:0.5;
}
#controls:hover{opacity:1}
#controls button{
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);
  color:rgba(200,210,230,0.8);padding:4px 10px;border-radius:4px;
  cursor:pointer;font-family:inherit;font-size:12px;transition:background .2s;
}
#controls button:hover{background:rgba(255,255,255,0.18)}
#seed-display{letter-spacing:0.5px}
#credit{
  position:fixed;bottom:16px;left:16px;
  font-family:'Courier New',monospace;font-size:11px;color:rgba(200,210,230,0.25);
  z-index:10;user-select:none;
}
</style>
</head>
<body>
<canvas id="c" aria-label="Generative flow field artwork"></canvas>
<div id="controls">
  <span id="seed-display"></span>
  <button id="btn-regen" title="New seed">&#x21bb;</button>
  <button id="btn-pause" title="Pause / Play">&#x23f8;</button>
</div>
<div id="credit">aivars.se</div>
<script>
(function(){
"use strict";

/* --- Seeded PRNG (mulberry32) --- */
function mulberry32(a){
  return function(){
    a|=0;a=a+0x6D2B79F5|0;
    var t=Math.imul(a^a>>>15,1|a);
    t=t+Math.imul(t^t>>>7,61|t)^t;
    return((t^t>>>14)>>>0)/4294967296;
  };
}

/* --- Seed from URL or random --- */
function getSeed(){
  var p=new URLSearchParams(window.location.search);
  var s=p.get("seed");
  if(s!==null&&s!==""&&!isNaN(Number(s)))return Number(s);
  return Math.floor(Math.random()*999999)+1;
}

var seed=getSeed();
var rng=mulberry32(seed);

/* --- Canvas setup --- */
var canvas=document.getElementById("c");
var ctx=canvas.getContext("2d");
var W,H,cols,rows,field;
var SCALE=18;
var PARTICLES=2800;
var particles=[];
var paused=false;
var frameId;

function resize(){
  var dpr=Math.min(window.devicePixelRatio||1,2);
  W=window.innerWidth;H=window.innerHeight;
  canvas.width=W*dpr;canvas.height=H*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  cols=Math.ceil(W/SCALE)+1;
  rows=Math.ceil(H/SCALE)+1;
}

/* --- Palette --- */
function buildPalette(r){
  var base=[
    [20,180,220],[80,140,255],[160,80,255],
    [255,60,180],[255,140,60],[40,255,160]
  ];
  /* shuffle slightly with seed */
  var pal=[];
  for(var i=0;i<base.length;i++){
    var c=base[i];
    pal.push([
      Math.min(255,Math.max(0,c[0]+((r()*60-30)|0))),
      Math.min(255,Math.max(0,c[1]+((r()*60-30)|0))),
      Math.min(255,Math.max(0,c[2]+((r()*60-30)|0)))
    ]);
  }
  return pal;
}

var palette;

/* --- Noise (simplex-like via seed) --- */
var perm=new Uint8Array(512);
function buildPerm(r){
  var p=new Uint8Array(256);
  for(var i=0;i<256;i++)p[i]=i;
  for(var i=255;i>0;i--){
    var j=(r()*i)|0;
    var t=p[i];p[i]=p[j];p[j]=t;
  }
  for(var i=0;i<512;i++)perm[i]=p[i&255];
}

function fade(t){return t*t*t*(t*(t*6-15)+10)}
function lerp(a,b,t){return a+t*(b-a)}
function grad(h,x,y){
  var v=h&3;
  return((v&1)?-x:x)+((v&2)?-y:y);
}
function noise2d(x,y){
  var xi=Math.floor(x)&255,yi=Math.floor(y)&255;
  var xf=x-Math.floor(x),yf=y-Math.floor(y);
  var u=fade(xf),v=fade(yf);
  var aa=perm[perm[xi]+yi],ab=perm[perm[xi]+yi+1];
  var ba=perm[perm[xi+1]+yi],bb=perm[perm[xi+1]+yi+1];
  return lerp(
    lerp(grad(aa,xf,yf),grad(ba,xf-1,yf),u),
    lerp(grad(ab,xf,yf-1),grad(bb,xf-1,yf-1),u),
    v
  );
}

/* --- Flow field --- */
var time=0;
var OCTAVES=3;
function flowAngle(x,y,t){
  var nx=x*0.004,ny=y*0.004;
  var v=0,amp=1,freq=1;
  for(var o=0;o<OCTAVES;o++){
    v+=noise2d(nx*freq+t*0.3,ny*freq+t*0.15)*amp;
    amp*=0.5;freq*=2.2;
  }
  return v*Math.PI*2.5;
}

/* --- Particles --- */
function createParticle(r,palette){
  var ci=(r()*palette.length)|0;
  var c=palette[ci];
  return{
    x:r()*W,y:r()*H,
    vx:0,vy:0,
    life:0,
    maxLife:80+r()*200,
    r:c[0],g:c[1],b:c[2],
    alpha:0.015+r()*0.035,
    size:0.5+r()*1.5,
    speed:0.6+r()*1.4
  };
}

function resetParticle(p,r,palette){
  var ci=(r()*palette.length)|0;
  var c=palette[ci];
  p.x=r()*W;p.y=r()*H;
  p.vx=0;p.vy=0;
  p.life=0;
  p.maxLife=80+r()*200;
  p.r=c[0];p.g=c[1];p.b=c[2];
  p.alpha=0.015+r()*0.035;
  p.size=0.5+r()*1.5;
  p.speed=0.6+r()*1.4;
}

function initParticles(){
  particles=[];
  for(var i=0;i<PARTICLES;i++){
    particles.push(createParticle(rng,palette));
  }
}

/* --- Drawing --- */
function draw(){
  /* Fade background */
  ctx.fillStyle="rgba(5,5,16,0.035)";
  ctx.fillRect(0,0,W,H);

  time+=0.003;

  for(var i=0;i<PARTICLES;i++){
    var p=particles[i];
    var angle=flowAngle(p.x,p.y,time);
    p.vx=p.vx*0.92+Math.cos(angle)*p.speed*0.08;
    p.vy=p.vy*0.92+Math.sin(angle)*p.speed*0.08;
    p.x+=p.vx;
    p.y+=p.vy;
    p.life++;

    /* Fade in/out */
    var lifeFrac=p.life/p.maxLife;
    var opacity=p.alpha;
    if(lifeFrac<0.1)opacity*=lifeFrac/0.1;
    else if(lifeFrac>0.8)opacity*=(1-lifeFrac)/0.2;

    if(p.life>p.maxLife||p.x<-20||p.x>W+20||p.y<-20||p.y>H+20){
      resetParticle(p,rng,palette);
      continue;
    }

    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size,0,6.2832);
    ctx.fillStyle="rgba("+p.r+","+p.g+","+p.b+","+opacity.toFixed(4)+")";
    ctx.fill();
  }
}

function loop(){
  if(!paused){draw();frameId=requestAnimationFrame(loop);}
}

/* --- Init --- */
function init(){
  rng=mulberry32(seed);
  buildPerm(rng);
  palette=buildPalette(rng);
  resize();
  time=0;
  /* Clear canvas fully */
  ctx.fillStyle="#050510";
  ctx.fillRect(0,0,W,H);
  initParticles();
  document.getElementById("seed-display").textContent="seed: "+seed;
  if(frameId)cancelAnimationFrame(frameId);
  paused=false;
  document.getElementById("btn-pause").innerHTML="&#x23f8;";
  loop();
}

/* --- Controls --- */
document.getElementById("btn-regen").addEventListener("click",function(){
  seed=Math.floor(Math.random()*999999)+1;
  var url=new URL(window.location);
  url.searchParams.set("seed",seed);
  window.history.replaceState(null,"",url);
  init();
});

document.getElementById("btn-pause").addEventListener("click",function(){
  paused=!paused;
  this.innerHTML=paused?"&#x25b6;":"&#x23f8;";
  if(!paused)loop();
});

window.addEventListener("resize",function(){
  resize();
  ctx.fillStyle="#050510";
  ctx.fillRect(0,0,W,H);
});

init();

})();
</script>
</body>
</html>
